<!doctype html>

<head>
</head>

<body style="margin: 0px;">
    <canvas id="main"></canvas>
</body>
<script>
var centerX;
var centerY;
var canvas = document.getElementById('main');
var ctx = canvas.getContext("2d");
var add = 1;
var height = 10;
var width = 10;
var marbles = [];
var platforms = [];
var numberOfMarbles = 1;
var landed = 0;
var paused = false;
var animationSpeed = 0;
var ready = true;
var animationTimer = 0;

window.addEventListener('load', function() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight - 20;

    centerX = canvas.width / 2;
    centerY = canvas.height / 2;

    for (var i = 0; i < numberOfMarbles; i++) {
        marbles.push(new Marble(i, Math.floor(Math.random() * canvas.width) + 1))
    }

    platforms.push(new Platform(200, 400, 300))
    platforms.push(new Platform(600, 100, 100))
    platforms.push(new Platform(600, 800, 100))
    platforms.push(new Platform(800, 700, 100))
    platforms.push(new Platform(100, 300, 200))
    platforms.push(new Platform(0, canvas.height, canvas.width))

    // setInterval(function() {
    //     marbles.push(new Marble(marbles.length + 1, Math.floor(Math.random() * canvas.width) + 1));
    // }, 1000)

    animate();

}, false);

document.addEventListener('click', function(e) {
    paused = !paused;
    animate();
})

function animate() {

    if (!paused) requestAnimationFrame(animate);
    ctx.lineWidth = "1px"
    if (ready) ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (var i = 0; i < marbles.length; i++) {
        if (ready) marbles[i].fall();
    }
    for (var i = 0; i < platforms.length; i++) {
        platforms[i].draw();
    }

    if (animationTimer < animationSpeed) {
        ready = false;
        animationTimer++
    } else {
        animationTimer = 0;
        ready = true;
    }
}

function Platform(x, y, length) {
    var platform = this;
    platform.x = x;
    platform.y = y;
    platform.length = length;
    platform.endx = platform.x + platform.length;
    platform.draw = draw;

    function draw() {
        ctx.beginPath();
        ctx.moveTo(platform.x, platform.y);
        ctx.lineTo(platform.endx, platform.y);
        ctx.closePath();
        ctx.stroke();
    }
}

//tells us if the marble has hit a platform
function didCollide(object) {
    var closest = closestPlatform(object);
    var result = object.y === closest.y - object.radius;
    return result;
}


function aboutToCollide(object) {
    var closest = closestPlatform(object);
    if (object.y + object.yspeed >= closest.y - object.radius) {
        return closest.y - object.radius;
    }
    return object.y + object.yspeed;
}

function closestPlatform(object) {
    var currentPlatform;
    platforms.forEach(function(platform) {
        if (object.x >= platform.x - object.radius && object.x <= platform.endx + object.radius && platform.y - object.radius >= object.y) {
            if (!currentPlatform || platform.y < currentPlatform.y) {
                currentPlatform = platform;
            }
        }
    });
    return currentPlatform || platforms[platforms.length - 1];
}

function didSettle(object) {
    var closest = closestPlatform(object);
    //if the marble  will surpass the position of the platform on its next move, then we call it 'settled'
    if (object.y + object.yspeed > closest.y - object.radius) {
        return true;
    }
    return false;
}

function onPlatform(object) {
    var onPlatform = false;
    //check each platform -- if the marble is within any platforms 'x' range and it has the same 'y' it is on the platform
    //ALSO - it must not be bouncing.
    platforms.forEach(function(platform) {
        if (object.x >= platform.x - object.radius && object.x <= platform.endx + object.radius && object.y === platform.y - object.radius) {
            onPlatform = true;
        }
    });
    return onPlatform;
}

function Marble(id, x, y) {
    var colorArray = [0, 0, 0];
    var marble = this;
    var colorIndex1 = Math.floor(Math.random() * 3);
    var colorIndex2 = Math.floor(Math.random() * 3);
    var size = 15;
    var counter = 0;
    var timer = 0;
    marble.velocity = 0.07;
    marble.id = id;
    marble.bouncing = false;
    marble.x = x || 0;
    marble.y = y || -size;
    marble.weight = 3;
    marble.radius = size;
    marble.diameter = size * 2;
    marble.fall = fall;
    marble.opacity = 1;
    marble.setColor = setColor;
    marble.color = null;
    marble.xspeed = (Math.floor(Math.random() * 2) == 1 ? 1 : -1) * 3;
    marble.yspeed = Math.random() * 3 + 1;

    return marble;

    var settled = false;

    function fall() {
        if (!settled) {
            if (didCollide(marble) || marble.bouncing) {
                bounce();
            } else {
                marble.yspeed = marble.yspeed * (1 + marble.velocity);
            }

            marble.y = aboutToCollide(marble);

        } else {
            marble.yspeed = 3;
            marble.velocity = 0.07;
            //var closest = closestPlatform(marble);
            //if (closest !== platforms[platforms.length - 1])
            if (marble.x < 0 || marble.x > canvas.width) {
                marbles[marble.id] = new Marble(marble.id, Math.floor(Math.random() * canvas.width) + 1);
                timer = 0;
            }
            //marble.opacity -= 0.01
            timer++;
            settled = onPlatform(marble);
        }

        setColor();
        marble.x += marble.xspeed;
        draw(marble.x, marble.y);


        function bounce() {
            //turn on the bounce
            if (!marble.bouncing) {
                marble.bouncing = true;
                marble.velocity = marble.velocity * marble.weight;
                marble.yspeed = -marble.yspeed;
            }
            var bounceComplete = Math.abs(marble.yspeed) < Math.abs(marble.velocity) + 1;

            //send the ball up, decreasing marble.yspeed
            if (marble.bouncing && !bounceComplete) {
                marble.yspeed = marble.yspeed * (1 - marble.velocity);
            }

            //turn off the bounce, marble.yspeed is slow, start a new fall
            if (marble.bouncing && bounceComplete) {
                marble.bouncing = false;
                marble.yspeed = -marble.yspeed;
            }

            settled = didSettle(marble);
            if (settled) marble.bouncing = false;

        }
    }



    function setColor() {
        colorArray[0] += Math.floor(marble.yspeed);
        marble.color = "rgba(" + colorArray.join(',') + "," + marble.opacity + ")";
    }


    function draw(offsetX, offsetY) {
        ctx.beginPath();
        ctx.fillStyle = marble.color;
        ctx.arc(offsetX, offsetY, marble.radius, 0, 2 * Math.PI);
        ctx.fill();
        ctx.closePath();
    }

}
</script>

</html>
